@startuml
'https://plantuml.com/sequence-diagram

autonumber
@startuml
'https://plantuml.com/sequence-diagram
autonumber
actor Customer as c

participant BuyController as bc
participant ExternalPurchaseSystem as eps
participant OrderService as ps

participant BuyService as bs

participant LicenseService as ls
participant OrderRepository as os

participant LicenseRepository as lr

database Database as db



eps -> ps: paymentCompleted(OrderId)
activate eps
activate ps
ps --> eps: request received
deactivate eps

ps -> os:getOrder(OrderId)
activate os
os->db:getOrder(OrderId)
db --> os:return Order
os --> ps:return Order
deactivate os




ps-> bs: buyConfirmed(Order)

deactivate ps
activate bs



loop for(Product p : List<Product>)

    bs-> ls: manageLicenses(ProductID)
    activate ls
    loop for(Service s : List<Service>)
        ls->lr: checkLicenses((ProductID)
        lr->ls: return List<License>


        ls -> ls : new License()
    end
        ls -> lr: extendedLicense(List<License>, vin)
        activate lr

        lr -> db:extendedLicense(List<License>, vin)
        db -> lr: return boolean
        lr --> ls: return boolean
        deactivate lr
        ls-->bs: return boolean
        deactivate ls

    end
bs --> bc: return boolean
deactivate bs
activate bc
bc --> c: return boolean
deactivate bc




@enduml